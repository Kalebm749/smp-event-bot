<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Event Handler Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .status {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .running { color: #4caf50; }
        .stopped { color: #f44336; }
        .unknown { color: #ff9800; }

        .monitor-buttons button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            background-color: #3a4a6f;
            color: #e0e0e0;
        }
        .monitor-buttons button:hover { background-color: #50628b; }

        .container { text-align: center; padding: 20px; }

        /* Health Check Styles */
        .health-checks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            text-align: left;
        }

        .health-card {
            background-color: #1c2a42;
            border: 2px solid #3a4a6f;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .health-card.healthy {
            border-color: #4caf50;
        }

        .health-card.unhealthy {
            border-color: #f44336;
        }

        .health-card.checking {
            border-color: #ff9800;
        }

        .health-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #666;
        }

        .health-status-indicator.healthy {
            background-color: #4caf50;
        }

        .health-status-indicator.unhealthy {
            background-color: #f44336;
        }

        .health-status-indicator.checking {
            background-color: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .health-details {
            font-size: 14px;
            line-height: 1.6;
        }

        .health-details .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .health-details .detail-label {
            color: #ccc;
        }

        .health-details .detail-value {
            color: #fff;
            font-weight: bold;
        }

        .health-details .error-message {
            color: #f44336;
            font-style: italic;
            margin-top: 10px;
        }

        .refresh-health {
            background-color: #2e3e5d;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .refresh-health:hover {
            background-color: #3a4a6f;
        }

        .overall-health {
            background-color: #1c2a42;
            border: 2px solid #3a4a6f;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .overall-health.healthy {
            border-color: #4caf50;
            background-color: #1e2f1e;
        }

        .overall-health.unhealthy {
            border-color: #f44336;
            background-color: #2f1e1e;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <h1>Event Handler Monitor</h1>
        
        <!-- Event Handler Status -->
        <div class="status" id="status">Checking...</div>

        <div class="monitor-buttons">
            <button id="start-btn">Start Event Handler</button>
            <button id="stop-btn">Stop Event Handler</button>
        </div>

        <!-- Overall System Health -->
        <div class="overall-health" id="overall-health">
            <h3>Overall System Health: <span id="overall-status">Checking...</span></h3>
        </div>

        <!-- Health Checks -->
        <div class="health-checks">
            <!-- Minecraft Server Health -->
            <div class="health-card checking" id="minecraft-card">
                <div class="health-title">
                    <div class="health-status-indicator checking" id="minecraft-indicator"></div>
                    Minecraft Server
                </div>
                <div class="health-details" id="minecraft-details">
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="minecraft-status">Checking...</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Last Check:</span>
                        <span class="detail-value" id="minecraft-last-check">-</span>
                    </div>
                </div>
                <button class="refresh-health" onclick="checkMinecraftHealth()">Refresh</button>
            </div>

            <!-- RCON Health -->
            <div class="health-card checking" id="rcon-card">
                <div class="health-title">
                    <div class="health-status-indicator checking" id="rcon-indicator"></div>
                    RCON Connection
                </div>
                <div class="health-details" id="rcon-details">
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="rcon-status">Checking...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Response Time:</span>
                        <span class="detail-value" id="rcon-response-time">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Check:</span>
                        <span class="detail-value" id="rcon-last-check">-</span>
                    </div>
                </div>
                <button class="refresh-health" onclick="checkRconHealth()">Refresh</button>
            </div>
        </div>
    </div>

    <script>
        async function refreshStatus() {
            try {
                const res = await fetch("/api/event_handler_status");
                const data = await res.json();
                const statusDiv = document.getElementById("status");
                statusDiv.textContent = data.status;
                statusDiv.className = "status " + (data.status === "Running" ? "running" : "stopped");
            } catch (err) {
                console.error("Error fetching status:", err);
                const statusDiv = document.getElementById("status");
                statusDiv.textContent = "Error";
                statusDiv.className = "status stopped";
            }
        }

        document.getElementById("start-btn").addEventListener("click", async () => {
            await fetch("/api/event_handler/start", { method: "POST" });
            refreshStatus();
        });

        document.getElementById("stop-btn").addEventListener("click", async () => {
            await fetch("/api/event_handler/stop", { method: "POST" });
            refreshStatus();
        });

        async function checkMinecraftHealth() {
            updateHealthCard('minecraft', 'checking', 'Checking...', {});
            
            try {
                const res = await fetch("/api/health/minecraft");
                const data = await res.json();
                
                if (data.healthy) {
                    updateHealthCard('minecraft', 'healthy', 'Online', {
                        'Last Check': new Date().toLocaleTimeString()
                    });
                } else {
                    updateHealthCard('minecraft', 'unhealthy', 'Offline', {
                        'Last Check': new Date().toLocaleTimeString(),
                        'Error': data.error || 'Connection failed'
                    });
                }
            } catch (error) {
                updateHealthCard('minecraft', 'unhealthy', 'Error', {
                    'Last Check': new Date().toLocaleTimeString(),
                    'Error': error.message
                });
            }
            
            updateOverallHealth();
        }

        async function checkRconHealth() {
            updateHealthCard('rcon', 'checking', 'Checking...', {});
            
            try {
                const startTime = Date.now();
                const res = await fetch("/api/health/rcon");
                const responseTime = Date.now() - startTime;
                const data = await res.json();
                
                if (data.healthy) {
                    updateHealthCard('rcon', 'healthy', 'Connected', {
                        'Response Time': responseTime + 'ms',
                        'Last Check': new Date().toLocaleTimeString()
                    });
                } else {
                    updateHealthCard('rcon', 'unhealthy', 'Failed', {
                        'Response Time': responseTime + 'ms',
                        'Last Check': new Date().toLocaleTimeString(),
                        'Error': data.error || 'Connection failed'
                    });
                }
            } catch (error) {
                updateHealthCard('rcon', 'unhealthy', 'Error', {
                    'Last Check': new Date().toLocaleTimeString(),
                    'Error': error.message
                });
            }
            
            updateOverallHealth();
        }

        function updateHealthCard(type, status, statusText, details) {
            const card = document.getElementById(`${type}-card`);
            const indicator = document.getElementById(`${type}-indicator`);
            const statusElement = document.getElementById(`${type}-status`);
            
            // Update card status
            card.className = `health-card ${status}`;
            indicator.className = `health-status-indicator ${status}`;
            statusElement.textContent = statusText;
            
            // Update details
            Object.entries(details).forEach(([label, value]) => {
                const element = document.getElementById(`${type}-${label.toLowerCase().replace(/\s+/g, '-')}`);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function updateOverallHealth() {
            const minecraftCard = document.getElementById('minecraft-card');
            const rconCard = document.getElementById('rcon-card');
            const overallHealth = document.getElementById('overall-health');
            const overallStatus = document.getElementById('overall-status');
            
            const minecraftHealthy = minecraftCard.classList.contains('healthy');
            const rconHealthy = rconCard.classList.contains('healthy');
            
            if (minecraftHealthy && rconHealthy) {
                overallHealth.className = 'overall-health healthy';
                overallStatus.textContent = 'All Systems Operational';
            } else {
                overallHealth.className = 'overall-health unhealthy';
                const issues = [];
                if (!minecraftHealthy) issues.push('Minecraft Server');
                if (!rconHealthy) issues.push('RCON');
                overallStatus.textContent = `Issues Detected: ${issues.join(', ')}`;
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
        
        // Auto-refresh health checks every 60 seconds
        setInterval(() => {
            checkMinecraftHealth();
            checkRconHealth();
        }, 60000);

        // Initial load
        document.addEventListener("DOMContentLoaded", () => {
            refreshStatus();
            checkMinecraftHealth();
            checkRconHealth();
        });
    </script>
</body>
</html>