<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Additional styles for database viewer */
        .db-info-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .db-info-section {
            flex: 1;
            margin-right: 15px;
        }
        
        .db-info-section:last-child {
            margin-right: 0;
        }
        
        .badge {
            background-color: #3a4a6f;
            color: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #3a4a6f;
        }
        
        .tab-button {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            border-bottom: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-button.active {
            background-color: #3a4a6f;
            color: #ffffff;
        }
        
        .tab-button:hover:not(.active) {
            background-color: #2e3e5d;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            padding: 5px;
            border-radius: 4px;
        }
        
        textarea {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .query-controls {
            margin-bottom: 15px;
        }
        
        .example-queries {
            margin-top: 15px;
        }
        
        .example-queries h4 {
            margin-bottom: 10px;
        }
        
        .example-button {
            background-color: #2e3e5d;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .example-button:hover {
            background-color: #3a4a6f;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .alert-danger {
            background-color: #4d2c2c;
            border: 1px solid #8b3a3a;
        }
        
        .alert-success {
            background-color: #2c4d2c;
            border: 1px solid #3a8b3a;
        }
        
        .alert-info {
            background-color: #2c3d4d;
            border: 1px solid #3a5f8b;
        }
        
        .table-responsive {
            overflow-x: auto;
            background-color: #1c2a42;
            border-radius: 4px;
            border: 1px solid #3a4a6f;
        }
        
        .pagination-info {
            margin-top: 10px;
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <!-- Database Info Panel -->
        <div class="panel">
            <h2>Database Information</h2>
            <div id="db-info">
                <div class="loading">Loading database information...</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tab-nav">
            <div class="tab-button active" onclick="switchTab('events')">Events</div>
            <div class="tab-button" onclick="switchTab('notifications')">Notifications</div>
            <div class="tab-button" onclick="switchTab('logs')">Logs</div>
            <div class="tab-button" onclick="switchTab('winners')">Winners</div>
            <div class="tab-button" onclick="switchTab('query')">Custom Query</div>
            <div class="tab-button" onclick="switchTab('admin')" style="background-color: #8b3a3a;">üîí Admin</div>
        </div>

        <!-- Tab Contents -->
        <div id="events-tab" class="tab-content active">
            <div class="panel">
                <div class="table-header">
                    <h2>Events Table</h2>
                    <button class="refresh-btn" onclick="loadTable('events')">Refresh</button>
                </div>
                <div id="events-table">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>

        <div id="notifications-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Event Notifications Table</h2>
                    <button class="refresh-btn" onclick="loadTable('event_notifications')">Refresh</button>
                </div>
                <div id="notifications-table">
                    <div class="loading">Loading notifications...</div>
                </div>
            </div>
        </div>

        <div id="logs-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Logs Table</h2>
                    <div class="controls">
                        <select id="logs-limit">
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                            <option value="500">500 rows</option>
                        </select>
                        <button class="refresh-btn" onclick="loadTable('logs')">Refresh</button>
                    </div>
                </div>
                <div id="logs-table">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>

        <div id="winners-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Event Winners Table</h2>
                    <button class="refresh-btn" onclick="loadTable('event_winners')">Refresh</button>
                </div>
                <div id="winners-table">
                    <div class="loading">Loading winners...</div>
                </div>
            </div>
        </div>

        <div id="query-tab" class="tab-content">
            <div class="panel">
                <h2>Custom SQL Query</h2>
                <p style="color: #888; margin-bottom: 15px;">Execute custom SELECT queries (other query types are blocked for safety)</p>
                
                <div class="query-controls">
                    <textarea id="query-input" rows="4" placeholder="SELECT * FROM events WHERE..." style="width: 100%; box-sizing: border-box;"></textarea>
                </div>
                
                <div class="controls">
                    <button class="refresh-btn" onclick="executeQuery()">Execute Query</button>
                    <button class="refresh-btn" onclick="clearQuery()">Clear</button>
                </div>
                
                <div class="example-queries">
                    <h4>Example Queries:</h4>
                    <div id="example-buttons"></div>
                </div>
                
                <div id="query-results"></div>
            </div>
        </div>

        <div id="admin-tab" class="tab-content">
            <div class="panel">
                <h2 style="color: #f44336;">üîí Database Administration</h2>
                <p style="color: #888; margin-bottom: 20px;">‚ö†Ô∏è Warning: These actions are permanent and cannot be undone!</p>
                
                <!-- Password Protection -->
                <div id="admin-password-section">
                    <div style="max-width: 400px; margin-bottom: 30px;">
                        <label for="admin-password" style="display: block; margin-bottom: 10px; font-weight: bold;">Master Password:</label>
                        <input type="password" id="admin-password" placeholder="Enter DATABASE_MASTER password" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #1c2a42; color: #e0e0e0; border: 1px solid #3a4a6f; border-radius: 4px;">
                        <button onclick="unlockAdmin()" style="background-color: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Unlock Admin Functions</button>
                    </div>
                </div>

                <!-- Admin Functions (hidden until unlocked) -->
                <div id="admin-functions" style="display: none;">
                    
                    <!-- Clear Logs Section -->
                    <div style="background-color: #2f1e1e; border: 1px solid #8b3a3a; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #f44336; margin-top: 0;">Clear Application Logs</h3>
                        <p style="color: #ccc;">Remove all log entries from the database. This will not affect event data.</p>
                        <div style="margin-top: 15px;">
                            <button onclick="clearLogs()" style="background-color: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Clear All Logs</button>
                            <span id="logs-status" style="color: #888;"></span>
                        </div>
                    </div>

                    <!-- Delete Events Section -->
                    <div style="background-color: #2f1e1e; border: 1px solid #8b3a3a; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #f44336; margin-top: 0;">Delete Events</h3>
                        <p style="color: #ccc;">Completely remove events and all related data (notifications, winners, etc.)</p>
                        
                        <!-- Event Selection -->
                        <div style="margin-bottom: 15px;">
                            <label for="event-to-delete" style="display: block; margin-bottom: 5px; font-weight: bold;">Select Event to Delete:</label>
                            <select id="event-to-delete" style="width: 100%; max-width: 500px; padding: 8px; background-color: #1c2a42; color: #e0e0e0; border: 1px solid #3a4a6f; border-radius: 4px;">
                                <option value="">Loading events...</option>
                            </select>
                            <button onclick="refreshEventsList()" style="background-color: #3a4a6f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Refresh</button>
                        </div>

                        <!-- Event Details Preview -->
                        <div id="event-details" style="background-color: #1c2a42; border: 1px solid #3a4a6f; border-radius: 4px; padding: 15px; margin-bottom: 15px; display: none;">
                            <h4 style="margin-top: 0; color: #e0e0e0;">Event Details:</h4>
                            <div id="event-info"></div>
                        </div>

                        <!-- Delete Button -->
                        <div style="margin-top: 15px;">
                            <button onclick="deleteEvent()" id="delete-event-btn" disabled style="background-color: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: not-allowed;">Delete Event & All Related Data</button>
                            <span id="delete-status" style="color: #888; margin-left: 15px;"></span>
                        </div>
                    </div>

                    <!-- Delete JSON Files Section -->
                    <div style="background-color: #2f1e1e; border: 1px solid #8b3a3a; border-radius: 6px; padding: 20px;">
                        <h3 style="color: #f44336; margin-top: 0;">Delete Event Templates</h3>
                        <p style="color: #ccc;">Delete event JSON template files. This will not affect scheduled events, only the templates used to create new events.</p>
                        
                        <!-- JSON File Selection -->
                        <div style="margin-bottom: 15px;">
                            <label for="json-to-delete" style="display: block; margin-bottom: 5px; font-weight: bold;">Select JSON Template to Delete:</label>
                            <select id="json-to-delete" style="width: 100%; max-width: 500px; padding: 8px; background-color: #1c2a42; color: #e0e0e0; border: 1px solid #3a4a6f; border-radius: 4px;">
                                <option value="">Loading JSON files...</option>
                            </select>
                            <button onclick="refreshJsonFilesList()" style="background-color: #3a4a6f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Refresh</button>
                        </div>

                        <!-- JSON File Details Preview -->
                        <div id="json-details" style="background-color: #1c2a42; border: 1px solid #3a4a6f; border-radius: 4px; padding: 15px; margin-bottom: 15px; display: none;">
                            <h4 style="margin-top: 0; color: #e0e0e0;">File Details:</h4>
                            <div id="json-info"></div>
                        </div>

                        <!-- Delete JSON Button -->
                        <div style="margin-top: 15px;">
                            <button onclick="deleteJsonFile()" id="delete-json-btn" disabled style="background-color: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: not-allowed;">Delete JSON Template</button>
                            <span id="delete-json-status" style="color: #888; margin-left: 15px;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTable = '';
        let currentTab = 'events';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseInfo();
            loadTable('events');
            setupExampleQueries();

            // Add event listener for event selection (for admin tab)
            setTimeout(() => {
                const eventSelect = document.getElementById('event-to-delete');
                if (eventSelect) {
                    eventSelect.addEventListener('change', function() {
                        const deleteBtn = document.getElementById('delete-event-btn');
                        
                        if (this.value) {
                            deleteBtn.disabled = false;
                            deleteBtn.style.backgroundColor = '#f44336';
                            deleteBtn.style.cursor = 'pointer';
                            
                            // Show event details
                            const eventText = this.selectedOptions[0].textContent;
                            document.getElementById('event-info').innerHTML = `<strong>${eventText}</strong>`;
                            document.getElementById('event-details').style.display = 'block';
                            document.getElementById('delete-status').textContent = '';
                        } else {
                            deleteBtn.disabled = true;
                            deleteBtn.style.backgroundColor = '#666';
                            deleteBtn.style.cursor = 'not-allowed';
                            document.getElementById('event-details').style.display = 'none';
                        }
                    });
                }
            }, 1000);

            // Add event listener for JSON file selection
            setTimeout(() => {
                const jsonSelect = document.getElementById('json-to-delete');
                if (jsonSelect) {
                    jsonSelect.addEventListener('change', function() {
                        const deleteBtn = document.getElementById('delete-json-btn');
                        
                        if (this.value) {
                            deleteBtn.disabled = false;
                            deleteBtn.style.backgroundColor = '#f44336';
                            deleteBtn.style.cursor = 'pointer';
                            
                            // Show JSON file details
                            const fileText = this.selectedOptions[0].textContent;
                            document.getElementById('json-info').innerHTML = `<strong>${fileText}</strong>`;
                            document.getElementById('json-details').style.display = 'block';
                            document.getElementById('delete-json-status').textContent = '';
                        } else {
                            deleteBtn.disabled = true;
                            deleteBtn.style.backgroundColor = '#666';
                            deleteBtn.style.cursor = 'not-allowed';
                            document.getElementById('json-details').style.display = 'none';
                        }
                    });
                }
            }, 1000);
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Load data for tab if not already loaded
            if (tabName === 'events' && !document.getElementById('events-table').innerHTML.includes('table')) {
                loadTable('events');
            } else if (tabName === 'notifications' && !document.getElementById('notifications-table').innerHTML.includes('table')) {
                loadTable('event_notifications');
            } else if (tabName === 'logs' && !document.getElementById('logs-table').innerHTML.includes('table')) {
                loadTable('logs');
            } else if (tabName === 'winners' && !document.getElementById('winners-table').innerHTML.includes('table')) {
                loadTable('event_winners');
            }
        }

        function loadDatabaseInfo() {
            fetch('/api/database/info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('db-info').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        return;
                    }

                    let html = '<div class="db-info-panel">';
                    
                    // Tables section
                    html += '<div class="db-info-section">';
                    html += '<h3>Tables</h3>';
                    if (data.tables) {
                        html += '<ul style="list-style: disc; margin-left: 20px;">';
                        data.tables.forEach(table => {
                            const count = data.row_counts ? data.row_counts[table] || 0 : 0;
                            html += `<li>${table}: <span class="badge">${count} rows</span></li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';
                    
                    // Stats section
                    html += '<div class="db-info-section">';
                    html += '<h3>Database Stats</h3>';
                    html += `<p><strong>Size:</strong> ${data.size_mb || 'Unknown'} MB</p>`;
                    html += `<p><strong>File Size:</strong> ${data.size_bytes || 'Unknown'} bytes</p>`;
                    html += '</div>';
                    
                    html += '</div>';

                    document.getElementById('db-info').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('db-info').innerHTML = `<div class="alert alert-danger">Failed to load database info: ${error}</div>`;
                });
        }

        function loadTable(tableName) {
            currentTable = tableName;
            const targetDiv = tableName === 'event_notifications' ? 'notifications-table' : `${tableName.replace('event_', '')}-table`;

            // Get limit for logs
            let limit = 50;
            if (tableName === 'logs') {
                limit = document.getElementById('logs-limit')?.value || 50;
            }

            document.getElementById(targetDiv).innerHTML = '<div class="loading">Loading data...</div>';

            // Use enhanced endpoint for notifications and winners
            const endpoint = (tableName === 'event_notifications' || tableName === 'event_winners') 
                ? `/api/database/enhanced-table/${tableName}?limit=${limit}`
                : `/api/database/table/${tableName}?limit=${limit}`;

            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById(targetDiv).innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        return;
                    }

                    if (!data.rows || data.rows.length === 0) {
                        document.getElementById(targetDiv).innerHTML = '<div class="alert alert-info">No data found in this table.</div>';
                        return;
                    }

                    // Build table HTML
                    let html = '<div class="table-responsive"><table>';
                    
                    // Add headers
                    html += '<thead><tr>';
                    data.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    html += '</tr></thead>';
                    
                    // Add rows
                    html += '<tbody>';
                    data.rows.forEach(row => {
                        html += '<tr>';
                        data.columns.forEach(col => {
                            let value = row[col];

                            // Format timestamps
                            if (col.includes('time') || col === 'timestamp' || col === 'sent_at' || col === 'rewarded_at') {
                                if (value) {
                                    const date = new Date(value);
                                    value = `<small>${date.toLocaleString()}</small>`;
                                }
                            }

                            // Truncate long text
                            if (typeof value === 'string' && value.length > 100) {
                                value = value.substring(0, 100) + '...';
                            }

                            // Handle null/undefined
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }

                            html += `<td>${value}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';

                    // Add pagination info
                    html += `<div class="pagination-info">Showing ${data.rows.length} of ${data.total} total rows</div>`;

                    document.getElementById(targetDiv).innerHTML = html;
                })
                .catch(error => {
                    document.getElementById(targetDiv).innerHTML = `<div class="alert alert-danger">Failed to load table: ${error}</div>`;
                });
        }

        function executeQuery() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }

            document.getElementById('query-results').innerHTML = '<div class="loading">Executing query...</div>';

            fetch('/api/database/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('query-results').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    document.getElementById('query-results').innerHTML = '<div class="alert alert-info">Query executed successfully, but returned no results.</div>';
                    return;
                }

                // Build results table
                let html = `<div class="alert alert-success">Query executed successfully. Found ${data.count} results.</div>`;
                html += '<div class="table-responsive"><table>';
                
                // Get column headers from first row
                const firstRow = data.results[0];
                html += '<thead><tr>';
                
                if (Array.isArray(firstRow)) {
                    for (let i = 0; i < firstRow.length; i++) {
                        html += `<th>Column ${i + 1}</th>`;
                    }
                } else {
                    Object.keys(firstRow).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                }
                html += '</tr></thead>';
                
                // Add rows
                html += '<tbody>';
                data.results.forEach(row => {
                    html += '<tr>';
                    if (Array.isArray(row)) {
                        row.forEach(cell => {
                            let value = cell;
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }
                            html += `<td>${value}</td>`;
                        });
                    } else {
                        Object.values(row).forEach(cell => {
                            let value = cell;
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }
                            html += `<td>${value}</td>`;
                        });
                    }
                    html += '</tr>';
                });
                html += '</tbody></table></div>';

                document.getElementById('query-results').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('query-results').innerHTML = `<div class="alert alert-danger">Failed to execute query: ${error}</div>`;
            });
        }

        function clearQuery() {
            document.getElementById('query-input').value = '';
            document.getElementById('query-results').innerHTML = '';
        }

        function setupExampleQueries() {
            const exampleQueries = [
                "SELECT * FROM events ORDER BY start_time DESC LIMIT 10",
                "SELECT name, start_time, event_over FROM events WHERE event_over = 1",
                "SELECT COUNT(*) as total_events FROM events",
                "SELECT log_level, COUNT(*) as count FROM logs GROUP BY log_level",
                "SELECT e.name, w.player_name, w.final_score FROM events e JOIN event_winners w ON e.id = w.event_id",
                "SELECT notification_type, COUNT(*) as sent_count FROM event_notifications GROUP BY notification_type"
            ];

            const container = document.getElementById('example-buttons');
            exampleQueries.forEach((query, index) => {
                const button = document.createElement('button');
                button.className = 'example-button';
                button.textContent = query.split(' ').slice(0, 4).join(' ') + '...';
                button.onclick = () => {
                    document.getElementById('query-input').value = query;
                };
                container.appendChild(button);
            });
        }

        // Admin functions
        function unlockAdmin() {
            const password = document.getElementById('admin-password').value;
            
            fetch('/api/database/admin-unlock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('admin-password-section').style.display = 'none';
                    document.getElementById('admin-functions').style.display = 'block';
                    refreshEventsList();
                    refreshJsonFilesList();
                } else {
                    alert('Invalid password');
                    document.getElementById('admin-password').value = '';
                }
            })
            .catch(error => {
                alert('Error validating password');
            });
        }

        function clearLogs() {
            if (!confirm('Are you sure you want to delete ALL log entries? This cannot be undone.')) {
                return;
            }

            document.getElementById('logs-status').textContent = 'Clearing logs...';
            
            fetch('/api/database/admin-clear-logs', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('logs-status').textContent = `‚úÖ Cleared ${data.deleted_count} log entries`;
                        // Refresh logs tab if it's currently loaded
                        if (currentTable === 'logs') {
                            loadTable('logs');
                        }
                    } else {
                        document.getElementById('logs-status').textContent = `‚ùå Error: ${data.error}`;
                    }
                })
                .catch(error => {
                    document.getElementById('logs-status').textContent = `‚ùå Error: ${error}`;
                });
        }

        function refreshEventsList() {
            const select = document.getElementById('event-to-delete');
            select.innerHTML = '<option value="">Loading events...</option>';
            
            fetch('/api/database/admin-events-list')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Select an event to delete...</option>';
                    
                    data.events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.name} (${event.unique_event_name}) - ${event.start_time}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    select.innerHTML = '<option value="">Error loading events</option>';
                });
        }

        function deleteEvent() {
            const eventId = document.getElementById('event-to-delete').value;
            if (!eventId) return;

            const eventName = document.getElementById('event-to-delete').selectedOptions[0].textContent;
            
            if (!confirm(`Are you ABSOLUTELY sure you want to permanently delete this event and ALL related data?\n\n${eventName}\n\nThis will delete:\n- Event record\n- All notifications\n- All winners\n- Cannot be undone!`)) {
                return;
            }

            document.getElementById('delete-status').textContent = 'Deleting...';
            document.getElementById('delete-event-btn').disabled = true;
            
            fetch('/api/database/admin-delete-event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('delete-status').textContent = `‚úÖ Event deleted successfully`;
                    refreshEventsList();
                    document.getElementById('event-details').style.display = 'none';
                    
                    // Refresh any loaded tables
                    if (['events', 'event_notifications', 'event_winners'].includes(currentTable)) {
                        loadTable(currentTable);
                    }
                } else {
                    document.getElementById('delete-status').textContent = `‚ùå Error: ${data.error}`;
                    document.getElementById('delete-event-btn').disabled = false;
                }
            })
            .catch(error => {
                document.getElementById('delete-status').textContent = `‚ùå Error: ${error}`;
                document.getElementById('delete-event-btn').disabled = false;
            });
        }

        function refreshJsonFilesList() {
            const select = document.getElementById('json-to-delete');
            select.innerHTML = '<option value="">Loading JSON files...</option>';
            
            fetch('/api/database/admin-json-files')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Select a JSON template to delete...</option>';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        option.textContent = `${file.filename} - ${file.event_name} (${file.size_bytes} bytes, modified: ${file.modified})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    select.innerHTML = '<option value="">Error loading JSON files</option>';
                });
        }

        function deleteJsonFile() {
            const filename = document.getElementById('json-to-delete').value;
            if (!filename) return;

            const fileText = document.getElementById('json-to-delete').selectedOptions[0].textContent;
            
            if (!confirm(`Are you ABSOLUTELY sure you want to permanently delete this JSON template?\n\n${fileText}\n\nThis will:\n- Delete the template file\n- Prevent creating new events of this type\n- NOT affect existing scheduled events\n- Cannot be undone!`)) {
                return;
            }

            document.getElementById('delete-json-status').textContent = 'Deleting...';
            document.getElementById('delete-json-btn').disabled = true;
            
            fetch('/api/database/admin-delete-json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('delete-json-status').textContent = `‚úÖ JSON template deleted successfully`;
                    refreshJsonFilesList();
                    document.getElementById('json-details').style.display = 'none';
                } else {
                    document.getElementById('delete-json-status').textContent = `‚ùå Error: ${data.error}`;
                    document.getElementById('delete-json-btn').disabled = false;
                }
            })
            .catch(error => {
                document.getElementById('delete-json-status').textContent = `‚ùå Error: ${error}`;
                document.getElementById('delete-json-btn').disabled = false;
            });
        }
    </script>
</body>
</html>