<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Additional styles for database viewer */
        .db-info-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .db-info-section {
            flex: 1;
            margin-right: 15px;
        }
        
        .db-info-section:last-child {
            margin-right: 0;
        }
        
        .badge {
            background-color: #3a4a6f;
            color: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #3a4a6f;
        }
        
        .tab-button {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            border-bottom: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-button.active {
            background-color: #3a4a6f;
            color: #ffffff;
        }
        
        .tab-button:hover:not(.active) {
            background-color: #2e3e5d;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            padding: 5px;
            border-radius: 4px;
        }
        
        textarea {
            background-color: #1c2a42;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .query-controls {
            margin-bottom: 15px;
        }
        
        .example-queries {
            margin-top: 15px;
        }
        
        .example-queries h4 {
            margin-bottom: 10px;
        }
        
        .example-button {
            background-color: #2e3e5d;
            color: #e0e0e0;
            border: 1px solid #3a4a6f;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .example-button:hover {
            background-color: #3a4a6f;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .alert-danger {
            background-color: #4d2c2c;
            border: 1px solid #8b3a3a;
        }
        
        .alert-success {
            background-color: #2c4d2c;
            border: 1px solid #3a8b3a;
        }
        
        .alert-info {
            background-color: #2c3d4d;
            border: 1px solid #3a5f8b;
        }
        
        .table-responsive {
            overflow-x: auto;
            background-color: #1c2a42;
            border-radius: 4px;
            border: 1px solid #3a4a6f;
        }
        
        .pagination-info {
            margin-top: 10px;
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <!-- Database Info Panel -->
        <div class="panel">
            <h2>Database Information</h2>
            <div id="db-info">
                <div class="loading">Loading database information...</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tab-nav">
            <div class="tab-button active" onclick="switchTab('events')">Events</div>
            <div class="tab-button" onclick="switchTab('notifications')">Notifications</div>
            <div class="tab-button" onclick="switchTab('logs')">Logs</div>
            <div class="tab-button" onclick="switchTab('winners')">Winners</div>
            <div class="tab-button" onclick="switchTab('query')">Custom Query</div>
        </div>

        <!-- Tab Contents -->
        <div id="events-tab" class="tab-content active">
            <div class="panel">
                <div class="table-header">
                    <h2>Events Table</h2>
                    <button class="refresh-btn" onclick="loadTable('events')">Refresh</button>
                </div>
                <div id="events-table">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>

        <div id="notifications-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Event Notifications Table</h2>
                    <button class="refresh-btn" onclick="loadTable('event_notifications')">Refresh</button>
                </div>
                <div id="notifications-table">
                    <div class="loading">Loading notifications...</div>
                </div>
            </div>
        </div>

        <div id="logs-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Logs Table</h2>
                    <div class="controls">
                        <select id="logs-limit">
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                            <option value="500">500 rows</option>
                        </select>
                        <button class="refresh-btn" onclick="loadTable('logs')">Refresh</button>
                    </div>
                </div>
                <div id="logs-table">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>

        <div id="winners-tab" class="tab-content">
            <div class="panel">
                <div class="table-header">
                    <h2>Event Winners Table</h2>
                    <button class="refresh-btn" onclick="loadTable('event_winners')">Refresh</button>
                </div>
                <div id="winners-table">
                    <div class="loading">Loading winners...</div>
                </div>
            </div>
        </div>

        <div id="query-tab" class="tab-content">
            <div class="panel">
                <h2>Custom SQL Query</h2>
                <p style="color: #888; margin-bottom: 15px;">Execute custom SELECT queries (other query types are blocked for safety)</p>
                
                <div class="query-controls">
                    <textarea id="query-input" rows="4" placeholder="SELECT * FROM events WHERE..." style="width: 100%; box-sizing: border-box;"></textarea>
                </div>
                
                <div class="controls">
                    <button class="refresh-btn" onclick="executeQuery()">Execute Query</button>
                    <button class="refresh-btn" onclick="clearQuery()">Clear</button>
                </div>
                
                <div class="example-queries">
                    <h4>Example Queries:</h4>
                    <div id="example-buttons"></div>
                </div>
                
                <div id="query-results"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTable = '';
        let currentTab = 'events';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseInfo();
            loadTable('events');
            setupExampleQueries();
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Load data for tab if not already loaded
            if (tabName === 'events' && !document.getElementById('events-table').innerHTML.includes('table')) {
                loadTable('events');
            } else if (tabName === 'notifications' && !document.getElementById('notifications-table').innerHTML.includes('table')) {
                loadTable('event_notifications');
            } else if (tabName === 'logs' && !document.getElementById('logs-table').innerHTML.includes('table')) {
                loadTable('logs');
            } else if (tabName === 'winners' && !document.getElementById('winners-table').innerHTML.includes('table')) {
                loadTable('event_winners');
            }
        }

        function loadDatabaseInfo() {
            fetch('/api/database/info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('db-info').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        return;
                    }

                    let html = '<div class="db-info-panel">';
                    
                    // Tables section
                    html += '<div class="db-info-section">';
                    html += '<h3>Tables</h3>';
                    if (data.tables) {
                        html += '<ul style="list-style: disc; margin-left: 20px;">';
                        data.tables.forEach(table => {
                            const count = data.row_counts ? data.row_counts[table] || 0 : 0;
                            html += `<li>${table}: <span class="badge">${count} rows</span></li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';
                    
                    // Stats section
                    html += '<div class="db-info-section">';
                    html += '<h3>Database Stats</h3>';
                    html += `<p><strong>Size:</strong> ${data.size_mb || 'Unknown'} MB</p>`;
                    html += `<p><strong>File Size:</strong> ${data.size_bytes || 'Unknown'} bytes</p>`;
                    html += '</div>';
                    
                    html += '</div>';

                    document.getElementById('db-info').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('db-info').innerHTML = `<div class="alert alert-danger">Failed to load database info: ${error}</div>`;
                });
        }

        function loadTable(tableName) {
            currentTable = tableName;
            const targetDiv = tableName === 'event_notifications' ? 'notifications-table' : `${tableName.replace('event_', '')}-table`;

            // Get limit for logs
            let limit = 50;
            if (tableName === 'logs') {
                limit = document.getElementById('logs-limit')?.value || 50;
            }

            document.getElementById(targetDiv).innerHTML = '<div class="loading">Loading data...</div>';

            fetch(`/api/database/table/${tableName}?limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById(targetDiv).innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        return;
                    }

                    if (!data.rows || data.rows.length === 0) {
                        document.getElementById(targetDiv).innerHTML = '<div class="alert alert-info">No data found in this table.</div>';
                        return;
                    }

                    // Build table HTML
                    let html = '<div class="table-responsive"><table>';
                    
                    // Add headers
                    html += '<thead><tr>';
                    data.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    html += '</tr></thead>';
                    
                    // Add rows
                    html += '<tbody>';
                    data.rows.forEach(row => {
                        html += '<tr>';
                        data.columns.forEach(col => {
                            let value = row[col];

                            // Format timestamps
                            if (col.includes('time') || col === 'timestamp' || col === 'sent_at' || col === 'rewarded_at') {
                                if (value) {
                                    const date = new Date(value);
                                    value = `<small>${date.toLocaleString()}</small>`;
                                }
                            }

                            // Truncate long text
                            if (typeof value === 'string' && value.length > 100) {
                                value = value.substring(0, 100) + '...';
                            }

                            // Handle null/undefined
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }

                            html += `<td>${value}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';

                    // Add pagination info
                    html += `<div class="pagination-info">Showing ${data.rows.length} of ${data.total} total rows</div>`;

                    document.getElementById(targetDiv).innerHTML = html;
                })
                .catch(error => {
                    document.getElementById(targetDiv).innerHTML = `<div class="alert alert-danger">Failed to load table: ${error}</div>`;
                });
        }

        function executeQuery() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }

            document.getElementById('query-results').innerHTML = '<div class="loading">Executing query...</div>';

            fetch('/api/database/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('query-results').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    document.getElementById('query-results').innerHTML = '<div class="alert alert-info">Query executed successfully, but returned no results.</div>';
                    return;
                }

                // Build results table
                let html = `<div class="alert alert-success">Query executed successfully. Found ${data.count} results.</div>`;
                html += '<div class="table-responsive"><table>';
                
                // Get column headers from first row
                const firstRow = data.results[0];
                html += '<thead><tr>';
                
                if (Array.isArray(firstRow)) {
                    for (let i = 0; i < firstRow.length; i++) {
                        html += `<th>Column ${i + 1}</th>`;
                    }
                } else {
                    Object.keys(firstRow).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                }
                html += '</tr></thead>';
                
                // Add rows
                html += '<tbody>';
                data.results.forEach(row => {
                    html += '<tr>';
                    if (Array.isArray(row)) {
                        row.forEach(cell => {
                            let value = cell;
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }
                            html += `<td>${value}</td>`;
                        });
                    } else {
                        Object.values(row).forEach(cell => {
                            let value = cell;
                            if (value === null || value === undefined) {
                                value = '<span style="color: #666;">null</span>';
                            }
                            html += `<td>${value}</td>`;
                        });
                    }
                    html += '</tr>';
                });
                html += '</tbody></table></div>';

                document.getElementById('query-results').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('query-results').innerHTML = `<div class="alert alert-danger">Failed to execute query: ${error}</div>`;
            });
        }

        function clearQuery() {
            document.getElementById('query-input').value = '';
            document.getElementById('query-results').innerHTML = '';
        }

        function setupExampleQueries() {
            const exampleQueries = [
                "SELECT * FROM events ORDER BY start_time DESC LIMIT 10",
                "SELECT name, start_time, event_over FROM events WHERE event_over = 1",
                "SELECT COUNT(*) as total_events FROM events",
                "SELECT log_level, COUNT(*) as count FROM logs GROUP BY log_level",
                "SELECT e.name, w.player_name, w.final_score FROM events e JOIN event_winners w ON e.id = w.event_id",
                "SELECT notification_type, COUNT(*) as sent_count FROM event_notifications GROUP BY notification_type"
            ];

            const container = document.getElementById('example-buttons');
            exampleQueries.forEach((query, index) => {
                const button = document.createElement('button');
                button.className = 'example-button';
                button.textContent = query.split(' ').slice(0, 4).join(' ') + '...';
                button.onclick = () => {
                    document.getElementById('query-input').value = query;
                };
                container.appendChild(button);
            });
        }
    </script>
</body>
</html>